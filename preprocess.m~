currentDirectory = pwd;

% CSV File
eegFiles = dir(fullfile(raw_directory,'*.csv'));

% Directory that stores raw files
rawDirectory = strcat(pwd, "/raw/");

% File to assist with source localization (ICA)
elpFile = char(strcat(pwd, "/res/standard-10-5-cap385.elp"));

% Channel Locations
channelLocationFile = char(strcat(pwd, "/res/td_asd_malaia.ced"));

% Sample Rate
sampleRate = 256;

for k = 1:length(eegFiles)
    file = strcat(rawDirectory, eegFiles(k).name);
    
    % Load EEG Data
    participantEEG = loadFile(file);
    
    %Get Sample Size
    sampleSize = getSampleSize(participantEEG);
    
    %Import file to EEGLAB
    EEG = pop_importdata('dataformat','array','nbchan',4,'data','participantEEG','srate',sampleRate,'pnts', sampleSize,'xmin',0);
    
    % Add Channels
    EEG = pop_chanedit(EEG, 'lookup',elpFile,'load',{channelLocationFile 'filetype' 'autodetect'});
    [ALLEEG EEG] = eeg_store(ALLEEG, EEG, CURRENTSET);
    
    %% Begin Preprocessing Pipeline
    
    % Reref Data
    EEG = pop_reref( EEG, []);
    
    %Clean line noise
    EEG = pop_cleanline(EEG, 'bandwidth',2,'chanlist', [1:34] ,'computepower',1,'linefreqs',60,'normSpectrum',0,'p',0.01,'pad',2,'plotfigures',0,'scanforlines',1,'sigtype','Channels','tau',100,'verb',1,'winsize',2,'winstep',1);
    
    % Add Hi Pass filter
    EEG = pop_eegfiltnew(EEG, 0.5, 30);
    
    % 
    [ALLEEG EEG CURRENTSET] = pop_newset(ALLEEG, EEG, 12,'setname', eegFiles(k).name,'gui','off');
    
    disp(EEG);
    
   
end

eeglab("redraw")

function sampleSize = getSampleSize(EEGDATA)

    %Get Number of Samples
    columnSize = size(EEGDATA);
    sampleSize = columnSize(2);
end

function EEG = loadFile(filename)
    disp(filename);
    file = csvread(char(filename), 1, 0);
    EEG = transpose(file);
end